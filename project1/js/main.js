const cartCount=document.querySelector(".cart__count"),cartLink=document.querySelector(".cart__btn"),makeOrder=document.querySelector(".make-order-btn"),cartBody=document.querySelector(".cart-items tbody"),errorMsg=document.querySelector(".make-order > .error");let afterOrder=!1;function setCardCount(){currentUser&&(cartCount.innerHTML=currentUser.cart.size,currentUser.cart.size?cartCount.style.display="inline-flex":cartCount.style.display="none")}function clearCart(){cartBody.innerHTML=""}function renderCart(){if(clearCart(),currentUser&&currentUser.cart.size)document.querySelector(".make-order").style.display="flex",currentUser.cart.goods.forEach((e=>{const t=findProduct(e.id);cartBody.innerHTML+=`\n          <tr>\n            <td>\n              <img class="cart-item__img" src="${t.mainImg}" alt="${t.name}">\n            </td>\n            <td><p>${t.name}</p></td>\n            <td><p>${t.price}<span class="product__price-currency">&nbsp;&#8372;</span></p></td>\n            <td>\n              <div class="product__counter counter" style="display: flex" data-id="${t.id}">\n              <button class="btn-reset counter__btn counter__dcr" type="button">\n                <svg>\n                  <use xlink:href="img/sprite.svg#dcr"></use>\n                </svg>\n              </button>\n              <input class="counter__input" type="text" value="${e.quantity}" />\n              <button class="btn-reset counter__btn counter__incr" type="button" ${e.quantity<t.amount||"disabled"}>\n                <svg>\n                  <use xlink:href="img/sprite.svg#incr"></use>\n                </svg>\n              </button>\n            </div>\n            </td>\n            <td>\n              <button class="btn-reset cart-item__delete" data-id="${e.id}" type="button">\n                <svg>\n                  <use xlink:href="img/sprite.svg#trash"></use>\n                </svg>\n              </button>\n            </td>\n          </tr>\n        `})),document.querySelector(".make-order .price").innerHTML=currentUser.cart.totalSum;else{cartBody.innerHTML=afterOrder?'\n    <tr>\n      <td class="fade"><p style="padding: 30px 14px 80px;\n      font-size: 36px;">Дякуємо за замовлення</p></td>\n    </tr>\n      ':'\n      <tr>\n        <td class="fade"><p style="padding: 30px 14px 80px;\n        font-size: 36px;">Порожній кошик</p></td>\n      </tr>\n      ',afterOrder=!1;document.querySelector(".make-order .price").innerHTML="",document.querySelector(".make-order").style.display="none"}document.querySelectorAll(".cart-item__delete").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation(),currentUser.cart.removeProduct(e.dataset.id),setCardCount(),renderCart()}))})),saveToLS(currentUser)}function counterControl(e){e.stopPropagation();const t=e.target.closest(".counter");if(t){const r=t.dataset.id,n=t.querySelector(".counter__input"),o=t.querySelector(".counter__incr"),s=t.querySelector(".counter__dcr"),c=findProduct(r).amount;s.contains(e.target)?(n.value>1&&n.value<=c?(n.value--,o.disabled=!1,currentUser.cart.changeQuantity(r,n.value)):currentUser.cart.removeProduct(r),renderCart()):o.contains(e.target)&&(n.value<c&&(n.value++,currentUser.cart.changeQuantity(r,n.value)),n.value==c&&(o.disabled=!0),renderCart()),setCardCount()}}cartLink.addEventListener("click",renderCart),makeOrder.onclick=function(e){e.preventDefault();try{if(null==currentUser.name||null==currentUser.money)throw new Error("Авторизуйтесь!");if(currentUser.money<currentUser.cart.totalSum)throw new Error("Не достатньо коштів!");currentUser.cart.checkout(),afterOrder=!0,setCardCount(),renderCatalog(loadingQuantity),renderCart()}catch(e){errorMsg.innerHTML=e.message}},cartBody.addEventListener("click",counterControl),cartBody.addEventListener("keypress",(e=>{e.target.closest(".counter__input")&&isNumber(e)})),cartBody.addEventListener("change",(e=>{if(e.target.closest(".counter__input")){const t=e.target.closest(".counter"),r=t.dataset.id,n=t.querySelector(".counter__incr"),o=findProduct(r).amount;0==e.target.value?(currentUser.cart.removeProduct(r),n.disabled=!1):e.target.value>=o?(n.disabled=!0,e.target.value=o,currentUser.cart.changeQuantity(r,e.target.value)):(n.disabled=!1,currentUser.cart.changeQuantity(r,e.target.value)),setCardCount(),renderCart()}}));const catalogList=document.querySelector(".catalog-list"),catalogLoadMore=document.querySelector(".catalog__more");let loadingQuantity=4,catalogLength=null,filteredProducts=[];async function loadProducts(){await getProductsFromDB(),renderCatalog(loadingQuantity)}function isProductInCart(e){let t=null;return currentUser&&currentUser.cart.goods.length&&(t=currentUser.cart.goods.find((t=>t.id===e))),{isInCart:!!t,inCartValue:t?.quantity||0}}function getFilters(){const e=document.forms.filters.elements;return{price:{min:e.price__min.value,max:e.price__max.value},instock:e.instock.checked?1:0,sort:e.sort.value}}catalogList&&(loadProducts(),catalogLoadMore.addEventListener("click",(e=>{loadingQuantity+=4,renderCatalog(loadingQuantity),visibilityLoadMore()})));const priceInput=document.querySelectorAll(".catalog-price__input");priceInput.forEach((e=>{e.addEventListener("keypress",(e=>{isNumber(e)}))}));const filters=document.forms.filters;function visibilityLoadMore(){catalogLoadMore.style.display=loadingQuantity>=catalogLength?"none":"block"}async function getProductsFromDB(){const e=await fetch("./data/products.json");result=await e.json(),products=result.map((e=>Object.assign(new Product,e)))}function renderCatalog(e){const t=getFilters();filteredProducts=products.filter((e=>e.price>=t.price.min&&e.price<=t.price.max&&e.amount>=t.instock)),filteredProducts.sort(((e,r)=>e.price>r.price?t.sort:e.price<r.price?-t.sort:0)),catalogLength=filteredProducts.length,catalogList.innerHTML="";for(let t=0;t<catalogLength;t++)if(t<e){let e=filteredProducts[t],r=!!e.amount||!1;const{isInCart:n,inCartValue:o}=isProductInCart(e.id);catalogList.innerHTML+=`\n      <li class="catalog-list__item">\n        <article\n          class="product ${n?"product--inCart":""} ${r?"":"product--disabled"}">\n          <div class="product__img">\n            <img src="${e.mainImg}" alt="${e.name}" />\n          </div>\n          <div class="product__content">\n            <h3 class="product__title">${e.name}</h3>\n            <p class="product__description"></p>\n            <div class="product__price">\n              <span class="product__price-value">${e.price}</span>\n              <span class="product__price-currency">&nbsp;&#8372;</span>\n            </div>\n            <div class="product__availability">\n            ${r?"Є в наявності":"Немає в наявності"}\n            </div>\n            <div class="product__control" data-product-id="${e.id}" data-product-name="${e.name}">\n              <div class="product__counter counter">\n                <button\n                  class="btn-reset counter__btn counter__dcr"\n                  type="button"\n                >\n                  <svg>\n                    <use xlink:href="img/sprite.svg#dcr"></use>\n                  </svg>\n                </button>\n                <input class="counter__input" type="text" value="${o||1}" />\n                <button\n                  class="btn-reset counter__btn counter__incr"\n                  type="button" ${o<e.amount||"disabled"}\n                >\n                  <svg>\n                    <use xlink:href="img/sprite.svg#incr"></use>\n                  </svg>\n                </button>\n              </div>\n              <button class="btn-reset product__btn" type="button">В кошик</button>\n            </div>\n          </div>\n        </article>\n      </li>\n      `}}filters.addEventListener("change",(()=>{loadingQuantity=4,renderCatalog(loadingQuantity),visibilityLoadMore(),console.log(getFilters())}));class Cart{constructor(){this.goods=[]}addProduct(e,t,r=1){this.goods.push({id:e,name:t,quantity:r})}changeQuantity(e,t){this.goods.find((t=>t.id===e)).quantity=t}removeProduct(e){this.goods.splice(this.goods.findIndex((t=>t.id===e)),1)}withdraw(){this.goods=[]}checkout(){this.goods.length&&currentUser.money>this.totalSum&&(currentUser.money-=this.totalSum,this.goods.forEach((e=>{products.find((t=>t.id===e.id)).substractAmount(e.quantity)})),currentUser.addOrder(),this.withdraw())}get totalSum(){return this.goods.reduce(((e,t)=>e+products.find((e=>e.id===t.id)).price*t.quantity),0)}get size(){return this.goods.length}}class Order{constructor(e,t){this.date=new Date,this.sum=t,this.products=e}}class Product{constructor(e,t,r){this.name=e,this.price=t,this.amount=r}substractAmount(e){this.amount-=e}}class User{constructor(e,t){this.id=`u${Date.now()}`,this.name=e,this.money=t,this.orders=[],this.cart=this.getCart()}showOrderHistory(e=1,t="date"){return this.orders.sort(((r,n)=>r[t]>n[t]?e:r[t]<n[t]?-e:0))}getCart(){return new Cart}addOrder(){this.orders.push(new Order(this.cart.goods,this.cart.totalSum))}}class Admin extends User{constructor(e){super(e)}createProduct(e,t,r){products.push(new Product(e,t,r))}}const modalLink=document.querySelectorAll(".modal-link"),modalClose=document.querySelectorAll(".modal__close"),body=document.querySelector("body"),header=document.querySelector(".header");let unlock=!0;function openPopup(e){const t=window.innerWidth-document.documentElement.clientWidth+"px";body.classList.add("lock"),body.style.paddingRight=t,header.style.paddingRight=t,e.classList.add("active"),e.addEventListener("click",closeFromLock)}function closePopup(e){if(e.classList.remove("active"),body.classList.remove("lock"),body.style.paddingRight="",header.style.paddingRight="",e.closest("#cart")){renderCatalog(loadingQuantity);document.querySelector(".make-order .price").innerHTML="",document.querySelector(".make-order").style.display="none",setTimeout(clearCart,500),errorMsg.innerHTML=""}e.closest("#new-user")&&(newUserName.value="",newUserMoney.value="",newUserName.style.borderColor="",newUserMoney.style.borderColor=""),e.removeEventListener("click",closeFromLock)}function closeFromLock(e){e.target.closest(".modal__area")||closePopup(e.target.closest(".modal"))}modalLink.length&&modalLink.forEach((e=>{e.addEventListener("click",(function(e){const t=document.querySelector(this.dataset.modal);e.preventDefault(),openPopup(t)}))})),modalClose.length&&modalClose.forEach((e=>{e.addEventListener("click",(function(t){closePopup(e.closest(".modal"))}))}));const navList=document.querySelector(".nav__list");navList.addEventListener("click",(e=>{e.preventDefault();const t=document.querySelector(".header").getBoundingClientRect().height;console.log(t);const r=e.target.closest(".nav__link");if(r&&/^#\w+/.test(r.hash)){const e=document.querySelector(r.hash).getBoundingClientRect().top-t+window.pageYOffset;console.log(e),window.scrollTo({top:e,behavior:"smooth"})}}));const newUserBtn=document.querySelector(".new-user__submit"),newUserName=document.querySelector(".new-user__name"),newUserMoney=document.querySelector(".new-user__money");function newUser(e,t){null!=currentUser.name&&null!=currentUser.money||(delete currentUser.id,currentUser=serializingUser(currentUser),currentUser.name=e,currentUser.money=t,saveToLS(currentUser)),currentUser=new User(e,t),changeStatusName()}function saveToLS(e){window.localStorage.setItem("last session",JSON.stringify(e))}newUserBtn.addEventListener("click",(function(e){if(e.preventDefault(),""==newUserName.value||""==newUserMoney.value)return""==newUserName.value?newUserName.style.borderColor="#f00":newUserName.style.borderColor="",void(""==newUserMoney.value?newUserMoney.style.borderColor="#f00":newUserMoney.style.borderColor="");newUser(newUserName.value,newUserMoney.value),closePopup(this.closest(".modal")),newUserName.value="",newUserMoney.value="",newUserName.style.borderColor="",newUserMoney.style.borderColor="",setCardCount(),renderCatalog(loadingQuantity)}));const ordersLink=document.querySelector(".orders-link"),ordersBody=document.querySelector("orders-items body");function renderOrders(){}catalogList.addEventListener("click",(e=>{const t=e.target.closest(".product__control");if(t){const r=t.dataset.productId,n=t.dataset.productName,o=t.querySelector(".counter__input"),s=t.querySelector(".counter__incr"),c=t.querySelector(".counter__dcr"),a=findProduct(r).amount;e.target.classList.contains("product__btn")?(currentUser.cart.addProduct(r,n),e.target.closest(".product").classList.add("product--inCart")):c.contains(e.target)?o.value>1&&o.value<=a?(o.value--,s.disabled=!1,currentUser.cart.changeQuantity(r,o.value)):(currentUser.cart.removeProduct(r),e.target.closest(".product").classList.remove("product--inCart")):s.contains(e.target)&&(o.value<a&&(o.value++,currentUser.cart.changeQuantity(r,o.value)),o.value==a&&(s.disabled=!0)),setCardCount(),saveToLS(currentUser)}})),catalogList.addEventListener("input",(e=>{if(e.target.closest(".counter__input")){const t=e.target.closest(".product__control"),r=t.dataset.productId,n=(t.dataset.productName,t.querySelector(".counter__incr")),o=findProduct(r).amount;0==e.target.value?(currentUser.cart.removeProduct(r),e.target.closest(".product").classList.remove("product--inCart"),e.target.value=1,n.disabled=!1):e.target.value>=o?(n.disabled=!0,e.target.value=o,currentUser.cart.changeQuantity(r,e.target.value)):(n.disabled=!1,currentUser.cart.changeQuantity(r,e.target.value)),setCardCount(),saveToLS(currentUser)}})),catalogList.addEventListener("keypress",(e=>{e.target.closest(".counter__input")&&isNumber(e)}));const lastSession=JSON.parse(window.localStorage.getItem("last session"));let currentUser=serializingUser(lastSession)||new User,products=[];function isEmptyObject(e){return!Object.keys(e).length}function isNumber(e){let t=e.which?e.which:e.keyCode;t>31&&(t<48||t>57)&&e.preventDefault()}function findProduct(e){return products.find((t=>t.id===e))}function serializingUser(e){let t=Object.assign(new User,e);return t.cart=Object.assign(new Cart,t.cart),t}function changeStatusName(){const e=document.querySelector(".link__status-name");null!=currentUser.name&&null!=currentUser.money?(console.log(currentUser.name),e.innerHTML=currentUser.name):e.innerHTML="Увійти"}setCardCount(),changeStatusName();